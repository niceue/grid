/*! nice Grid 0.1.0
 * (c) 2012-2013 Jony Zhang <zj86@live.cn>, MIT Licensed
 * http://niceue.com/grid/
 */
(function(t){var e=window.ActiveXObject?document.documentMode||(window.XMLHttpRequest?7:6):0,i=!!window.sidebar&&/Firefox\/\d/.test(navigator.userAgent);t.fn.grid=function(e){var i=t.grid.cache;return this.each(function(){var a=t(this).attr("data-gridguid");if(a&&i[a]){var s,n=i[a];switch(typeof e){case"string":return n[e](),void 0;case"object":if(n._mergeOptions(e),e.columns)return n.headRowCount&&n._empty(),n._create(),void 0;break;default:s=!0}n._submitHandler(null,s)}else e&&(e.container=this,new t.grid(e))})},t.grid=function(e){var i,a=t.grid.cache;if("string"==typeof e||e.tagName||e.jquery){if(i=t(e).attr("data-gridguid"),i&&a[i])return a[i]}else{if(!(this instanceof t.grid))return new t.grid(e);if(t.isPlainObject(e))return this._mergeOptions(e),this.el=t(this.options.container),i=this.el.attr("data-gridguid"),void 0!==i?a[i]._submitHandler():(this._construct(),e.columns&&this._create()),this}},t.grid.cache={},t.grid.guid=0,t.grid.prototype={options:{container:"#data_grid",context:null,delayLoad:!1,form:null,bindForm:!0,bindField:"",url:"",method:"POST",params:{},dataType:"json",dataRoot:"rows",recordKey:"recordCount",columns:[],summary:null,showRowIndex:!1,colMinWidth:35,colDefaultWidth:120,minRows:3,maxRows:null,onRender:{},title:"",height:null,fitWindow:!0,heightFix:20,checkbox:!1,checked:!0,selectable:!0,resizeable:!0,remoteSort:!0,sortName:"",sortOrder:"asc",showFooter:!0,pageSize:10,pageIndex:1},_construct:function(){this.guid=t.grid.guid++,this.el.attr("data-gridguid",this.guid);var e={};t("div[data-gridguid]").each(function(){e[this.getAttribute("data-gridguid")]=1}),t.each(t.grid.cache,function(i){e[i]||delete t.grid.cache[i]}),t.grid.cache[this.guid]=this},_mergeOptions:function(e){this.options=t.extend({},this.options,e),e.form&&(this.form="string"==typeof e.form?document.forms[e.form]:e.form,this.options.bindForm&&this.form&&!t(this.form).attr("data-gridbind")&&t(this.form).attr("data-gridbind",1).on("submit.grid",t.proxy(this,"_submitHandler")))},_create:function(){var t=[],e=this,i=e.options,a=i.columns,s=e._getHeadCols(a),n=e._getDataCols(a),d=e.headRowCount||1;if(i.context=i.context||i,e._getColWidth(n),e.extraCol=0,i.checkbox){e.extraCol++;var r={field:"checkbox",title:"single"===i.checkbox?"":'<input type="checkbox" class="checkAll" title="全选/全不选">'};1===d?s.unshift(r):s[0].unshift(r),n.unshift(r),e.colWidth.unshift(35),i.onRender.checkbox||(i.onRender.checkbox=function(t,e,a){var s=i.checked?t.Checked?" checked":"":"";return'<input type="checkbox" class="grid-checkbox" index='+a+s+">"})}if(i.showRowIndex||i.summary&&0===e.extraCol){e.extraCol++;var o={field:"rowIndex",title:""};1===d?s.unshift(o):s[0].unshift(o),n.unshift(o),e.colWidth.unshift(26),i.onRender.rowIndex=function(t,e,i){return i+1}}i.summary&&1===e.extraCol&&(e.colWidth[0]=i.colMinWidth),e.dataCols=n,e.fields=e._getFields(),t.push('<div class="grid-loading" style="display:none"></div>'),t.push('<table class="grid-wrap" width=100% cellpadding=0 cellspacing=0 border=0 style="position:relative;table-layout:fixed;_width:auto">'),i.title&&t.push('<tr><td style="padding:0"><div class="grid-title">',i.title,"</div></td></tr>"),t.push('<tr><td style="padding:0"><div class="grid-table">'),i.resizeable&&t.push(e._setSizer()),t.push('<table width=100% cellpadding=0 cellspacing=0 border=0><tr><td style="padding:0">'),t.push('<table cellpadding=0 cellspacing=0 border=0 class="grid-head">');var l=e._setExtraRow(n);t.push(l),t.push(e._setHead(s,d)),t.push("</table>"),t.push('<div class="grid-body"',e.gridBodyHeight?' style="height:'+e.gridBodyHeight+'px"':"",'><table cellpadding=0 cellspacing=0 border=0 class="grid-data"><thead>'),t.push(l),t.push('</thead><tbody class="gird-data-container">'),t.push('<tr class="last-row"><td colspan="',n.length,'">请输入查询条件查询</td><td class="fixed-td"></td><td class="last-td"></td></tr>'),t.push("</tbody></table></div>"),t.push("</td></tr></table>"),t.push("</div></td></tr>"),i.showFooter&&(t.push('<tr><td><div class="grid-foot">'),t.push('<div class="grid-pager"><a href="#" rel="start" class="grid-pagenav disabled">首页</a><a href="#" rel="prev" class="grid-pagenav disabled">上一页</a>'),t.push('<span style="margin-left:6px;margin-right:9px;" title="输入数字按Enter键切换页码"> 转到 <input type="text" class="grid-pagenav" value="1"> /<span class="page-count">0</span>页</span>'),t.push('<a href="#" rel="next" class="grid-pagenav disabled">下一页</a><a href="#" rel="end" class="grid-pagenav disabled">尾页</a></div>'),t.push('<div class="grid-counter">第<span>1</span>页, <span>0</span>条记录 / 共<span>0</span>条记录</div>'),t.push("</div></td></tr>")),t.push("</table>"),e.el.html(t.join("")),e._init()},_init:function(){var a=this,s=a.options;a.gridLoading=a.el.find("div.grid-loading")[0],a.gridTitle=a.el.find("div.grid-title"),a.gridHead=a.el.find("table.grid-head"),a.gridData=a.el.find("table.grid-data"),a.gridBody=a.el.find("div.grid-body"),a.gridTable=a.el.find("div.grid-table"),a.dataContainer=a.gridData.find("tbody.gird-data-container"),a.bindFields=s.bindField&&"string"==typeof s.bindField?s.bindField.split(" "):[],a.records=0,a.pageCount=0,a.ajaxComplete=!0,s.showFooter||(s.pageSize=1e4),s.height&&(s.fitWindow=!1),a.needHeight=s.fitWindow||s.height&&"auto"!==s.height,"string"==typeof s.height&&"rows"===s.height.substring(s.height.length-4)&&(s.minRows=+s.height.substring(0,s.height.length-4));var n=a.dataContainer.find("tr:eq(0)").height();a.minDataHeight=s.minRows*n,s.maxRows&&(a.maxDataHeight=s.maxRows*n),0===a.guid&&t(window).on("resize.grid",function(){s.fitWindow&&t.each(t.grid.cache,function(t,e){e.gridTable&&e._adjustSize()})}),a.el.on("complete.grid",t.proxy(a,"_onComplete")),a.el.on("click.grid","a.grid-pagenav",t.proxy(a,"_changePage")).on("keyup.grid","input.grid-pagenav",t.proxy(a,"_changePage")),a.el.on("focusout.grid","input.grid-pagenav",function(){var t=+this.value||s.pageIndex;s.pageIndex!==t?(s.pageIndex=t,a.queryData()):this.value=t}),6===e&&a.gridData.on("mouseenter mouseleave","tr",function(e){"mouseenter"===e.type?t(this).addClass("hover"):t(this).removeClass("hover")}),s.checkbox&&(s.selectable=!1,a.el.on("click.grid","input.checkAll",function(){var e=t(this).prop("checked");a.dataContainer.find(":checkbox").each(function(){t(this).prop("checked",e);var i=t(this).closest("tr");i.removeClass("row-checked"),e&&i.addClass("row-checked"),a._setData(i.attr("index"),"Checked",e)})}),a.gridData.on("click.grid","tr",function(e){var i,n=t(this),d="row-checked";t(e.target).is("td,:checkbox.grid-checkbox")&&("single"===s.checkbox&&(n.siblings().removeClass(d).find(":checkbox").prop("checked",!1),a._resetChecked()),i=n.toggleClass(d).hasClass(d),n.find(":checkbox").prop("checked",i),a._setData(n.attr("index"),"Checked",i))})),s.selectable&&a.gridData.on("click.grid","tr",function(e){var i=t(this),a="row-checked";t(e.target).is("a[fn]")?!i.hasClass(a)&&i.addClass(a):i.toggleClass(a),!e.ctrlKey&&i.siblings().removeClass(a)}),i&&a.gridData.on("mousedown.grid","tr",function(t){t.ctrlKey&&t.preventDefault()}),a.el.on("click.grid","span.sortable",function(){var e=t(this),i=e.attr("order")||s.sortOrder;s.sortName=e.closest("td").attr("field"),s.sortOrder=i,e.attr("order","asc"==i?"desc":"asc").removeClass("up dn").addClass("asc"===i?"up":"dn"),a._submitHandler()}),s.resizeable&&(a.gridSizer=a.gridTable.find("div.drag-handler"),a._dragInit()),a.gridData.on("click.grid","a[fn]",function(e){s.checkbox&&"single"!==s.checkbox&&e.stopPropagation(),e.preventDefault();var i=t(this),n=i.attr("fn"),d=a.data,r=i.closest("tr")[0].rowIndex-1;s.context[n].apply(s.context,[e,d[r]])}),a._adjustSize(),s.delayLoad?a._onComplete():a._submitHandler(),a.el.trigger("created.grid")},_submitHandler:function(e,i){if(e&&e.preventDefault(),this.ajaxComplete){var a={},s=this.options;if(this.form){var n=t(this.form).serializeArray();t.each(n,function(t,e){e.name in a?a[e.name]+=","+e.value:a[e.name]=e.value})}i||(s.pageIndex=1),this.postData=t.extend(a,s.params),this.queryData("form")}},queryData:function(e){var i=this,a=i.options,s={};a.data?i._onGetData(a.data,!0):!e&&i.frontPaging?(s[a.dataRoot]=i.data,i._onGetData(s,!0)):a.url?(i.gridLoading.style.display="",i.postData=t.extend({},i.postData,{pageIndex:a.pageIndex,pageSize:a.pageSize,sortName:a.sortName,sortOrder:a.sortOrder}),i.ajaxComplete=!1,t.ajax({context:i,cache:!1,url:a.url,type:a.method,dataType:a.dataType,data:i.postData,complete:function(){i.ajaxComplete=!0,i.gridLoading.style.display="none"},success:function(t){a.recordKey in t||(i.frontPaging=!0),i._onGetData(t)}})):(s[a.dataRoot]=[],s[a.recordKey]=0,i._onGetData(s))},_onGetData:function(t,e){var i,a,s,n=this,d=n.options;n.el.trigger("getdata",[t]),n.data=t[d.dataRoot],e||n.frontPaging?(a=(d.pageIndex-1)*d.pageSize,s=a+d.pageSize,n.records=n.data.length,i=n.data.slice(a,s)):(n.records=t[d.recordKey],i=n.data),n.pageRowCount=i.length,n.pageCount=Math.ceil(n.records/d.pageSize),n.renderData(i)},_onError:function(t){this.data=t,this.renderData()},renderData:function(e){var i=this,a=i.options,s=[],e=e||i.data||[],n="string"==typeof e?e:"",d=a.onRender;if(n||!e.length)s.push('<tr class="last-row"><td colspan="',i.dataCols.length,'">',n||"暂无数据!",'</td><td class="last-td"></td></tr>');else{for(var r,o,l,h,c=0,g=e.length,u=i.dataCols,p=u.length,f=i.bindFields,m=f.length,v=a.checkbox&&a.checked,b=0;g>c;c++){if(r=0,o=e[c],v||(o.Checked=0),s.push("<tr",v&&o.Checked?' class="row-checked"':""),m)for(var x=m;x--;)s.push(" data-"+f[x]+'="'+o[f[x]]+'"');for(s.push(' index="',c,'">');p>r;)l=u[r++],h=l.field,s.push("<td",l.align?" align="+l.align:"",">"),s.push(d[h]?d[h].apply(i,[o,o[h],c]):o[h],"</td>");s.push('<td class="last-td"></td></tr>')}if(b=g,a.summary){var y=i._getSummaryData(),w=i.extraCol,C=w>1?" colspan="+w:"";t.each(y,function(t,e){var i=w;for(s.push('<tr class="grid-summary">'),s.push("<td",C,">",e.summaryTitle,"</td>");p>i;)l=u[i++],h=l.field,s.push("<td",l.align?" align="+l.align:"",">"),s.push(e[h],"</td>");s.push('<td class="last-td"></td></tr>')}),b+=y.length}a.maxRows&&(i.needHeight=b>a.maxRows?!0:!1)}i.dataContainer.html(s.join("")),a.checkbox&&i.gridHead.find("input.checkAll").prop("checked",!1),i.isHide&&i.show(),i.el.trigger("complete.grid")},_onComplete:function(){this.gridSizer&&this.gridSizer.children().height(this.gridTable.height()),this.gridLoading.style.height=this.el.height()-10+"px",this.dataContainer.find("tr:last").addClass("last-row"),this.options.showFooter&&this._updatePager(),"need"===this.options.fitWindow&&this._adjustSize()},_adjustSize:function(){var t=this;t.timeout||(t.timeout=setTimeout(function(){if(e&&8>e){var i=t.gridTable[0];i.style.paddingBottom=t._isHScroll(i)?"17px":"0"}t.needHeight&&t._fitHeight(),t.timeout=null},50))},_fitHeight:function(){var e,i=this,a=i.options,s=0^a.height,n=i.gridTitle.height()||0,d=a.showFooter?31:0,r=i.minDataHeight,o=i.maxDataHeight,l=i.gridHead.height()+n+d+2+(i._isHScroll(i.gridTable[0])?17:0);a.fitWindow&&(s=t(window).height()-i.el.offset().top-a.heightFix),e=s-l,r>e&&(e=r),o&&e>o&&(e=o),i.gridBody.height(e),i.gridBodyHeight=e},_isHScroll:function(t){return 0!==t.scrollWidth-t.clientWidth},_getHeadCols:function(t){var e=this,i=[],a=function(t){var i=[];return e._mapTree(t,i),i.length},s=function(t,e,n){var d,r=0,o=t.length;for(!n&&e++,i[e]=i[e]||[];o>r;)d=t[r++],i[e].push(d),"columns"in d&&(d.rowspan=1,d.colspan=a(d.columns),s(d.columns,e))};return s(t,0,!0),e.headRowCount=i.length,1===i.length?i[0]:i},_getDataCols:function(t){if(1===this.headRowCount)return t;var e=[];return this._mapTree(t,e),e},_getColWidth:function(t){for(var e,i,a=[],s=[],n=0,d=t.length,r=this.options.colMinWidth,o=this.options.colDefaultWidth;d>n;)i=t[n++],e=i.minWidth||r,s.push(e),a.push(i.width?Math.max(i.width,e):o);this.minWidth=s,this.colWidth=a},_mapTree:function(t,e){for(var i,a=0,s=t.length;s>a;)i=t[a++],"columns"in i?this._mapTree(i.columns,e):e.push(i)},_setExtraRow:function(t){var e=[],i=0,a=t.length,s=this.colWidth;for(e.push('<tr class="first-row">');a>i;)e.push('<td style="width:',s[i++],'px"></td>');return e.push('<td class="fixed-td"></td><td></td></tr>'),e.join("")},_setHead:function(t,e){var i,a,s,n,d,r,o,l,h=[],c=e,g=0,u=t.length;if(1===c){for(h.push("<tr>");u>g;)i=t[g++],d=i.align?" align="+i.align:"",r=i.field?" field="+i.field:"",l=i.sortable&&i.field?' class="sortable"':"",h.push("<td",r,d,"><span",l,">",i.title,"</span>","</td>");h.push('<td class="fixed-td"></td><td class="last-td"></td></tr>')}else for(;u>g;g++){a=t[g],h.push("<tr>");for(var p=0,f=a.length;f>p;p++)i=a[p],s=i.colspan,s=s&&s>1?" colspan="+s:"",n=i.rowspan||c,n=n>1?" rowspan="+n:"",d=i.align?" align="+i.align:"",r=i.field?" field="+i.field:"",o=s?' class="colspan"':"",l=i.sortable&&i.field?' class="sortable"':"",h.push("<td",o,r,s,n,d,"><span",l,">",i.title,"</span>","</td>");0===g&&h.push('<td class="fixed-td" rowspan="',c,'"></td><td class="last-td" rowspan="',c,'"></td>'),h.push("</tr>"),c--}return h.join("")},_getFields:function(){var e=[];return t.each(this.dataCols,function(t,i){e.push(i.field)}),e.splice(0,this.extraCol),e},_getDecimal:function(t){var e=""+t,i=e.lastIndexOf(".");return-1!==i?e.length-i-1:0},_formatFloat:function(t,e){var i=Math.pow(10,e);return(t*i/i).toFixed(e)},_getSummary:function(){var e=this.dataCols.length,i=t.extend({},this.options.summary),a=Array(e);return t.each(i,function(t,s){for(var n=Array(e),d=0;s.length>d;d++)n[s[d]]=1,a[s[d]]=1;i[t]=n}),i.need=a,i},_getSummaryData:function(){for(var t,e,i,a,s,n=[],d=this.data,r=d.length,o=this.fields,l=o.length,h=this._getSummary(),c=h.sum,g=h.avg,u={summaryTitle:"平均"},p={summaryTitle:"合计"},f=0;l>f;f++)if(s=o[f],t=0,e=0,h.need[f]){a=this._getDecimal(d[0][s]||"");for(var m=0;r>m;m++)i=parseFloat(d[m][s]),i&&(t+=i);e=1*t/r,u[s]=g&&g[f]?this._formatFloat(e,a):"",p[s]=c&&c[f]?this._formatFloat(t,a):""}else u[s]="",p[s]="";return g&&n.push(u),c&&n.push(p),n},_updatePager:function(){var t=this.pageCount,e=this.options.pageIndex,i=this.el.find("div.grid-foot").children(),a=i.find("a"),s=i.find("input");s.length&&(i.find("span.page-count").text(t),1>=t?(s.prop("disabled",!0),a.removeClass("disabled").addClass("disabled").siblings("span").removeClass("disabled").addClass("disabled")):(s[0].value=e,s.prop("disabled",!1),1===e?a.slice(0,2).addClass("disabled").end().slice(-2).removeClass("disabled"):e===t?a.slice(-2).addClass("disabled").end().slice(0,2).removeClass("disabled"):a.removeClass("disabled"),a.siblings("span").removeClass("disabled")),i.eq(1).find("span").eq(0).text(e).end().eq(1).text(this.pageRowCount||0).end().eq(2).text(this.records).end())},_changePage:function(e){e.preventDefault();var i,a,s=t(e.target),n=this.options.pageIndex,d=this.pageCount;if(!s.hasClass("disabled")){if("keyup"===e.type)if(a=e.keyCode,13===a){if(i=+s.val()||1,n===i)return}else e.target.value=e.target.value.replace(/[^\d]/g,""),e.target.value>d&&(e.target.value=d);else switch(s.attr("rel")){case"start":i=1;break;case"prev":i=n-1;break;case"next":i=n+1;break;case"end":i=d}i&&(this.options.pageIndex=i,this.queryData())}},_setSizer:function(){var t=[],e=0,i=this.dataCols.length;for(t.push('<div class="drag-handler">');i>e;)t.push('<span class="drag-line" index="',e++,'"></span>');return t.push("</div>"),t.join("")},_dragInit:function(){var e,i,a,s,n,d=this,r=0,o=d.options,l=o.colMinWidth,h=d.gridHead[0].rows[0].cells,c=d.gridData[0].rows[0].cells,g=d.gridTable,u=d.gridSizer.children(),p=function(r){return e=r.currentTarget,t(e).addClass("moving"),i=parseInt(t(e).attr("index"),10),n=parseInt(h[i].style.width,10),l=d.minWidth[i],a=parseInt(e.style.left,10),s=r.clientX,t(document).on({"mousemove.grid":f,"mouseup.grid":v}),g.addClass("drag-panel"),!1},f=function(t){return r=t.clientX-s,l>=n+r&&(r=l-n),e.style.left=a+r+"px",!1},m=function(){var t,e=i+1,a=h.length-2,s=h[i].style,n=c[i].style,o=parseInt(s.width,10),l=parseInt(n.width,10);if(0!==r){for(s.width=o+r+"px",n.width=l+r+"px";a>e;)t=u.eq(e++)[0].style,t.left=parseInt(t.left,10)+r+"px";r=0,d._adjustSize()}},v=function(){t(document).off({"mousemove.grid":f,"mouseup.grid":v}),m(),g.removeClass("drag-panel"),t(e).removeClass("moving")};u.each(function(e){this.style.left=d.colWidth[e]+t(h[e]).position().left+"px"}),(o.checkbox||o.showRowIndex)&&(u.eq(0)[0].style.display="none"),o.checkbox&&o.showRowIndex&&(u.eq(1)[0].style.display="none"),d.el.on("mousedown.grid","span.drag-line",p)},_empty:function(){this.gridData&&this.gridData.off(),this.el.off(".grid"),this.el[0].innerHTML=""},_setData:function(t,e,i){var a,s=this,n=s.options;s.frontPaging&&(t=n.pageSize*(n.pageIndex-1)+ +t),a=s.data[t],a&&(a[e]=i)},_getChecked:function(){return this.dataContainer.find("tr.row-checked")},_resetChecked:function(){t.each(this.data,function(t,e){e.Checked=0})},_getCheckedRows:function(){var e=[],i=this.data;return t.each(i,function(t,i){i.Checked&&e.push(i)}),e},getDataByField:function(e){var i=[];return t.each(this.data,function(t,a){i[t]=a[e]}),i},getCheckedRows:function(){return this._getCheckedRows()},getCheckedData:function(t){return this._getCheckedRows(t)},removeCheckedRows:function(){var e=[];return t.each(this.data,function(t,i){i.Checked||e.push(i)}),this._onGetData({recordCount:e.length,rows:e}),e},_getValidData:function(t,e){var i=e.length,a="";if(i){for(;i--;)a+=t[e[i]];return a}},_getAllValidData:function(){var e=this,i=e.bindFields,a=[];if(i.length)return t.each(e.data,function(t,s){a.push(e._getValidData(s,i))}),a},addRows:function(e){if(t.isArray(e)){var i,a,s=this,n=[],d=s.bindFields;d.length&&(a=this._getAllValidData(),t.each(e,function(e,i){var r=s._getValidData(i,d);-1===t.inArray(r,a)&&(i.Checked=0,n.push(i))}),i=this.data.concat(n),this._onGetData({recordCount:i.length,rows:i}))}},editRow:function(e,i){if(void 0===e||!t.isPlainObject(i))return!1;var a=this.data[e];t.each(i,function(t,e){a[t]=e})},hide:function(){var t=this.el.children("table");t.length&&(t[0].style.display="none"),this.isHide=!0},show:function(){var t=this.el.children("table");t.length&&(t[0].style.display=""),this.isHide=!1,this._adjustSize()},destroy:function(){this._empty(),this.form&&t(this.form).off("submit.grid").removeAttr("data-gridbind"),this.el.removeAttr("data-gridguid"),delete t.grid.cache[this.guid]}}})(jQuery);
